name: ci

on:
  push:
  pull_request:

jobs:
  schemas:
    name: Schemas (validate + no duplicates)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure only canonical schema filenames exist
        run: |
          set -e
          if ls schemas/*.schema 1> /dev/null 2>&1; then
            echo "ERROR: Found non-canonical schemas/*.schema files. Use only *.schema.json"
            ls -la schemas/*.schema || true
            exit 1
          fi

      - name: Validate JSON files parse
        run: |
          python - <<'PY'
          import glob
          import json
          for path in glob.glob("schemas/*.schema.json"):
            with open(path, "r", encoding="utf-8") as handle:
              json.load(handle)
          print("OK: All schemas parse as JSON.")
          PY

      - name: Validate JSON Schema structure
        run: |
          python -m pip install --upgrade pip
          pip install check-jsonschema
          check-jsonschema --schemafile https://json-schema.org/draft/2020-12/schema schemas/*.schema.json

  backend:
    name: Backend (pytest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run tests
        env:
          LITECLAW_AUTH_TOKEN: test-token
        run: pytest -q

  desktop:
    name: Desktop (tauri build smoke)
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: apps/desktop
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend deps
        run: npm install

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Tauri build (smoke)
        run: npm run tauri build
